#run_emotion_analysis.py

import time
import os
import json
from emotion_recognition import analyze_audio
from fetch_results import get_analysis_results

TARGET_EMOTIONS = {"Joy", "Sadness", "Fear", "Disgust", "Anger", "Surprise (positive)",
    "Surprise (negative)"}

audio_path = "audio/s+j-clip7.m4a"

# Starts the analysis
job_id = analyze_audio(audio_path)

# Wait for processing (can increase wait time if needed)
print("Waiting for results...")
time.sleep(10)

# Fetch results from the API
results = get_analysis_results(job_id)

# Print full raw results
print(json.dumps(results, indent=4))

# Filtered emotion results
filtered_results = []

try:
    for entry in results:
        predictions = entry.get("results", {}).get("predictions", [])
        
        for prediction in predictions:
            models_data = prediction.get("models", {})
            prosody_model = models_data.get("prosody", {})
            grouped_predictions = prosody_model.get("grouped_predictions", [])
            
            for group in grouped_predictions:
                for segment in group.get("predictions", []):
                    emotions = segment.get("emotions", [])
                    
                    # Filters emotions based on TARGET_EMOTIONS
                    filtered = {
                        emo["name"]: emo["score"]
                        for emo in emotions
                        if emo["name"] in TARGET_EMOTIONS
                    }
                    
                    if filtered:  # Only append if we found matching emotions
                        filtered_results.append(filtered)

    # Check if we found any filtered results
    if not filtered_results:
        print("No matching emotions found.")

except Exception as e:
    print("Error while parsing results:", e)

# Saves results to JSON
filtered_results_folder = os.path.join("hume_ai", "filtered_results")
os.makedirs(filtered_results_folder, exist_ok=True)

# Extracts the base filename
file_name = os.path.splitext(os.path.basename(audio_path))[0]

# Creates unique file names 
output_file = os.path.join(filtered_results_folder, f"{file_name}_filtered_emotions.json")

with open(output_file, "w") as f:
    json.dump(filtered_results, f, indent=4)

print(f"Filtered emotions saved to '{output_file}'")